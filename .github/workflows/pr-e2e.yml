name: E2E

on:
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  android-sync-e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    env:
      APPIUM_HOME: ${{ github.workspace }}/.appium
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      ANDROID_API_LEVEL: '34'
      ANDROID_EMULATOR_ARCH: x86_64
      ANDROID_EMULATOR_PROFILE: pixel_6
      ANDROID_EMULATOR_TARGET: google_apis
      E2E_APPIUM_SERVER_URL: http://127.0.0.1:4723

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node + pnpm + install
        uses: ./.github/actions/setup-node-pnpm

      - name: Detect affected E2E projects
        id: affected-e2e
        run: |
          set -euo pipefail

          BASE_SHA="${{ github.event.pull_request.base.sha || github.event.before }}"
          HEAD_SHA="${{ github.sha }}"

          if ! git cat-file -e "${BASE_SHA}^{commit}" 2>/dev/null; then
            echo "Base commit ${BASE_SHA} is missing locally. Fetching base branch history..."
            git fetch --no-tags --prune origin "${{ github.event.pull_request.base.ref }}"
          fi

          AFFECTED_E2E_PROJECTS="$(pnpm nx show projects --affected --withTarget=e2e-ci --base=${BASE_SHA} --head=${HEAD_SHA} --json)"

          echo "affected e2e projects: $AFFECTED_E2E_PROJECTS"
          echo "projects=$AFFECTED_E2E_PROJECTS" >> "$GITHUB_OUTPUT"

          if [ "$AFFECTED_E2E_PROJECTS" = "[]" ]; then
            echo "has_e2e=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_e2e=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Java
        if: steps.affected-e2e.outputs.has_e2e == 'true'
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Cache Gradle user home
        if: steps.affected-e2e.outputs.has_e2e == 'true'
        id: gradle-cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/gradle-wrapper.properties', '**/*.gradle', '**/*.gradle.kts', '**/settings.gradle', '**/settings.gradle.kts') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Cache Appium extensions
        if: steps.affected-e2e.outputs.has_e2e == 'true'
        uses: actions/cache@v4
        with:
          path: ${{ env.APPIUM_HOME }}
          key: appium-${{ runner.os }}-${{ hashFiles('apps/*/package.json') }}
          restore-keys: |
            appium-${{ runner.os }}-

      - name: Prepare Android SDK cache directories
        if: steps.affected-e2e.outputs.has_e2e == 'true'
        run: |
          sudo mkdir -p \
            "${ANDROID_SDK_ROOT}/build-tools/35.0.0" \
            "${ANDROID_SDK_ROOT}/cmdline-tools" \
            "${ANDROID_SDK_ROOT}/platform-tools" \
            "${ANDROID_SDK_ROOT}/platforms/android-${ANDROID_API_LEVEL}" \
            "${ANDROID_SDK_ROOT}/emulator" \
            "${ANDROID_SDK_ROOT}/licenses"
          sudo chown -R "$USER:$USER" \
            "${ANDROID_SDK_ROOT}/build-tools/35.0.0" \
            "${ANDROID_SDK_ROOT}/cmdline-tools" \
            "${ANDROID_SDK_ROOT}/platform-tools" \
            "${ANDROID_SDK_ROOT}/platforms/android-${ANDROID_API_LEVEL}" \
            "${ANDROID_SDK_ROOT}/emulator" \
            "${ANDROID_SDK_ROOT}/licenses"

      - name: Cache Android SDK packages
        if: steps.affected-e2e.outputs.has_e2e == 'true'
        id: android-sdk-cache
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.ANDROID_SDK_ROOT }}/build-tools/35.0.0
            ${{ env.ANDROID_SDK_ROOT }}/cmdline-tools
            ${{ env.ANDROID_SDK_ROOT }}/platform-tools
            ${{ env.ANDROID_SDK_ROOT }}/platforms/android-${{ env.ANDROID_API_LEVEL }}
            ${{ env.ANDROID_SDK_ROOT }}/emulator
            ${{ env.ANDROID_SDK_ROOT }}/licenses
          key: android-sdk-${{ runner.os }}-api${{ env.ANDROID_API_LEVEL }}-${{ env.ANDROID_EMULATOR_TARGET }}-${{ env.ANDROID_EMULATOR_ARCH }}-v2
          restore-keys: |
            android-sdk-${{ runner.os }}-api${{ env.ANDROID_API_LEVEL }}-${{ env.ANDROID_EMULATOR_TARGET }}-${{ env.ANDROID_EMULATOR_ARCH }}-

      - name: Log cache status
        if: steps.affected-e2e.outputs.has_e2e == 'true'
        run: |
          echo "gradle cache hit: ${{ steps.gradle-cache.outputs.cache-hit }}"
          echo "android sdk cache hit: ${{ steps.android-sdk-cache.outputs.cache-hit }}"

      - name: Install Appium UiAutomator2 driver
        if: steps.affected-e2e.outputs.has_e2e == 'true'
        run: |
          set -euo pipefail

          INSTALLED_DRIVERS_RAW="$(pnpm --filter @minimalist-apps/android-sync exec appium driver list --installed 2>&1)"
          INSTALLED_DRIVERS="$(printf '%s\n' "$INSTALLED_DRIVERS_RAW" | sed -E 's/\x1B\[[0-9;]*[mK]//g')"

          echo "INSTALLED_DRIVERS:"
          printf '%s\n' "$INSTALLED_DRIVERS"

          if printf '%s\n' "$INSTALLED_DRIVERS" | grep -Eq 'uiautomator2@4\.2\.3([[:space:]]|$)'; then
            echo "Appium uiautomator2@4.2.3 already cached. Skipping install."
            exit 0
          fi

          if printf '%s\n' "$INSTALLED_DRIVERS" | grep -Eq 'uiautomator2@'; then
            echo "Different uiautomator2 version detected. Reinstalling 4.2.3."
            pnpm --filter @minimalist-apps/android-sync exec appium driver uninstall uiautomator2 || true
          fi

          pnpm --filter @minimalist-apps/android-sync exec appium driver install --source=npm appium-uiautomator2-driver@4.2.3

      - name: Start Appium server
        if: steps.affected-e2e.outputs.has_e2e == 'true'
        run: |
          pnpm --filter @minimalist-apps/android-sync run e2e:appium > appium.log 2>&1 &
          for i in {1..30}; do
            if curl -sf http://127.0.0.1:4723/status > /dev/null; then
              exit 0
            fi
            sleep 2
          done
          cat appium.log
          exit 1

      - name: Enable KVM group permissions
        if: steps.affected-e2e.outputs.has_e2e == 'true'
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Run Android emulator and E2E tests
        if: steps.affected-e2e.outputs.has_e2e == 'true'
        uses: reactivecircus/android-emulator-runner@v2
        with:
          force-avd-creation: true
          api-level: ${{ env.ANDROID_API_LEVEL }}
          arch: ${{ env.ANDROID_EMULATOR_ARCH }}
          profile: ${{ env.ANDROID_EMULATOR_PROFILE }}
          target: ${{ env.ANDROID_EMULATOR_TARGET }}
          emulator-boot-timeout: 600
          disable-linux-hw-accel: false
          disable-animations: true
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -no-snapshot -wipe-data
          script: |
            set -eu

            adb -s emulator-5554 shell rm -f /sdcard/e2e-run.mp4 || true
            adb -s emulator-5554 shell screenrecord --bit-rate 4000000 --time-limit 180 /sdcard/e2e-run.mp4 >/dev/null 2>&1 &
            recorder_pid=$!

            cleanup() {
              kill "$recorder_pid" >/dev/null 2>&1 || true
              adb -s emulator-5554 pull /sdcard/e2e-run.mp4 e2e-run.mp4 >/dev/null 2>&1 || true
            }

            trap cleanup EXIT

            pnpm nx affected -t e2e-ci --base=${{ github.event.pull_request.base.sha || github.event.before }} --head=${{ github.sha }} --parallel=1 --output-style=stream --verbose

      - name: No affected E2E projects
        if: steps.affected-e2e.outputs.has_e2e != 'true'
        run: echo "No affected projects with e2e-ci target; skipping E2E job body."

      - name: Upload Appium log on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: appium-log
          path: appium.log

      - name: Upload E2E video on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-video
          path: e2e-run.mp4
          if-no-files-found: warn
